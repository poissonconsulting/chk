---
title: "Benchmarking chk"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Benchmarking chk}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(chk)
library(microbenchmark)
```

## Conditional Checking

```{r}

fun_checking <- function(x) {
  chk_flag(x)
  NULL
}

.fun_checking <- function(x) {
  NULL
}

fun_checking_arg <- function(x, chk = TRUE) {
  if(chk) {
    chk_flag(x)
  }
  NULL
}
```

```{r}
times <- summary(microbenchmark(
  fun_checking(TRUE),
  .fun_checking(TRUE),
  fun_checking_arg(TRUE, chk = TRUE),
  fun_checking_arg(TRUE, chk = FALSE),
  unit = "us", times = 10000L
))[c("expr", "median")]
print(times)
```

In summary, avoiding `chk_flag()` saves about `r signif(diff(times$median[c(4,3)]),2)` $\mu$s while conditional checking using a `chk` argument costs about `r signif(diff(times$median[c(1,3)]),2)` $\mu$s.

It is recommended to always use unconditional checking unless [profiling](http://adv-r.had.co.nz/Profiling.html) indicates the checks are a bottleneck.

If the bottleneck is due to repeated calls within the package the recommended option is to write an internal version of the function that has no checks. 
Alternatively if the bottleneck is due to repeated calls by a user or other package then the recommended option is to add a chk argument that the user can explicitly turn off.

## `chk` Times

```{r}
true <- TRUE
false <- FALSE
one <- 1
oneL <- 1L
string <- "1"
date <- as.Date(1, origin = as.Date("1970-01-01"))
datetime <- as.POSIXct(1, origin = as.Date("1970-01-01"))
null <- NULL
named <- c("1" = 1)
fun <- function() NULL
data <- data.frame(one = one)
```

```{r}
summary(microbenchmark(
  chk_true(true),
  chk_false(false),
  chk_flag(true),
  chk_lgl(true),
  chk_number(oneL),
  chk_number(one),
  chk_whole_number(oneL),
  chk_whole_number(one),
  chk_string(string),
  chk_date(date),
  chk_datetime(datetime),
  chk_whole_numeric(oneL),
  chk_whole_numeric(one),
  chk_not_any_na(one),
  chk_unique(one),
  chk_unique(data),
  chk_unique(data, incomparables = NA),
  chk_null(null),
  chk_not_null(one),
  chk_named(named),
  chk_unused(),
  chk_used(one),
  chk_function(fun),
  chk_s3_class(one, "numeric"),
  chk_identical(one, one),
  chk_equal(one, one),
  chk_equivalent(one, one),
  chk_lt(one, 2),
  chk_lte(one, one),
  chk_gt(one, 0),
  chk_gte(one, one),
  chk_range(one),
  chk_subset(one, one),
  chk_superset(one, one),
  chk_match(string),
  chk_all(true, chk_true),
  chkor(),
  chkor(chk_number(one)),
  chkor(chk_number(one), chk_proportion(one)),
  unit = "us", times = 10000L
))[c("expr", "median")]
```
